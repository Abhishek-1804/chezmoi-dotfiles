{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Configure macOS system defaults
# Based on nix-darwin configuration

set -e

echo "Configuring macOS system defaults..."

# Disable guest account in login window
echo "Disabling guest account..."
sudo defaults write /Library/Preferences/com.apple.loginwindow GuestEnabled -bool false

# Finder: Use column view by default
echo "Setting Finder to column view..."
defaults write com.apple.finder FXPreferredViewStyle -string "clmv"

# Enable dark mode
echo "Enabling dark mode..."
defaults write NSGlobalDomain AppleInterfaceStyle -string "Dark"

# Set key repeat rate (2 = fast)
echo "Setting key repeat rate..."
defaults write NSGlobalDomain KeyRepeat -int 2

# Touch ID for sudo
echo "Configuring Touch ID for sudo..."
if [ ! -f /etc/pam.d/sudo_local ]; then
    echo "auth       sufficient     pam_tid.so" | sudo tee /etc/pam.d/sudo_local > /dev/null
    echo "Touch ID enabled for sudo"
else
    if ! grep -q "pam_tid.so" /etc/pam.d/sudo_local; then
        echo "auth       sufficient     pam_tid.so" | sudo tee /etc/pam.d/sudo_local > /dev/null
        echo "Touch ID enabled for sudo"
    else
        echo "Touch ID already configured for sudo"
    fi
fi

# Restart Finder to apply changes
echo "Restarting Finder..."
killall Finder

echo ""
echo "macOS defaults configured!"
echo ""
echo "MANUAL STEPS REQUIRED:"
echo "1. Remap Caps Lock to Control:"
echo "   System Settings > Keyboard > Keyboard Shortcuts > Modifier Keys"
echo "   Select your keyboard, then set Caps Lock to Control"
echo ""
echo "Note: Key repeat settings may require logout/login to take full effect"
{{ end -}}
